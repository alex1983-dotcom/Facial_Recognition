# üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞: `Face_Recognition`

> **–¶–µ–ª—å**: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ª–∏—Ü –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö CV-–º–æ–¥–µ–ª–µ–π.  
> **–°—Ç–µ–∫**: Python, OpenCV, InsightFace, Jupyter Lab, matplotlib  
> **–§–æ—Ä–º–∞—Ç**: –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π (Jupyter) > –≥–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ backend (FastAPI)

---

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
face_recognition_project/
‚îÇ
‚îú‚îÄ‚îÄ .venv/                     # –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ Python
‚îú‚îÄ‚îÄ requirements.txt           # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ README.md                  # –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
‚îÇ
‚îú‚îÄ‚îÄ notebooks/
‚îÇ   ‚îî‚îÄ‚îÄ 01_face_detection.ipynb        # –û—Å–Ω–æ–≤–Ω–æ–π –Ω–æ—É—Ç–±—É–∫: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ face_utils/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py                # –ü–∞–∫–µ—Ç–Ω—ã–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä
‚îÇ       ‚îú‚îÄ‚îÄ detector.py                # –ü—Ä–æ—Å—Ç–æ–π –¥–µ—Ç–µ–∫—Ç–æ—Ä (OpenCV DNN)
‚îÇ       ‚îú‚îÄ‚îÄ insightface_detector.py    # –ú–æ—â–Ω—ã–π –¥–µ—Ç–µ–∫—Ç–æ—Ä (InsightFace + RetinaFace)
‚îÇ       ‚îî‚îÄ‚îÄ utils.py                   # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ raw/
‚îÇ       ‚îî‚îÄ‚îÄ test.jpg                   # –¢–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
‚îÇ
‚îî‚îÄ‚îÄ models/                            # –º–æ–¥–µ–ª–∏ –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∑–¥–µ—Å—å,
                                       # –Ω–æ InsightFace —Å–∫–∞—á–∏–≤–∞–µ—Ç –∏—Ö –≤ ~/.insightface
```

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (`requirements.txt`)

```txt
opencv-python-headless>=4.9.0
numpy>=1.24.0
matplotlib>=3.7.0
jupyterlab>=3.6.0
insightface>=0.7.0
onnxruntime>=1.16.0
```

> ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `opencv-python-headless`, –ø–æ—Ç–æ–º—É —á—Ç–æ:
> - –†–∞–±–æ—Ç–∞–µ–º –≤ Jupyter (GUI –Ω–µ –Ω—É–∂–µ–Ω),
> - –ò–∑–±–µ–≥–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å `cv2.imshow()`.

–£—Å—Ç–∞–Ω–æ–≤–∫–∞:
```bash
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# –∏–ª–∏ .venv\Scripts\activate  # Windows
pip install -r requirements.txt
```

---

## üß† –ú–æ–¥—É–ª–∏ –∏ –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ

### ‚úÖ `src/face_utils/__init__.py`

–ü—É—Å—Ç–æ–π —Ñ–∞–π–ª ‚Äî –¥–µ–ª–∞–µ—Ç –ø–∞–ø–∫—É `face_utils` Python-–ø–∞–∫–µ—Ç–æ–º.

---

### ‚úÖ `src/face_utils/detector.py`  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü—Ä–æ—Å—Ç–æ–π –¥–µ—Ç–µ–∫—Ç–æ—Ä –ª–∏—Ü –Ω–∞ –æ—Å–Ω–æ–≤–µ OpenCV DNN (SSD + ResNet-10).

#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–µ–¥–æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å `res10_300x300_ssd_iter_140000.caffemodel`.
2. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç RGB-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
3. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ BGR > —Å–æ–∑–¥–∞—ë—Ç blob > –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —á–µ—Ä–µ–∑ –Ω–µ–π—Ä–æ—Å–µ—Ç—å.
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –±–æ–∫—Å–æ–≤: `(x, y, —à–∏—Ä–∏–Ω–∞, –≤—ã—Å–æ—Ç–∞)`.

#### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –ù–µ –Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–æ—Ñ–∏–ª–∏, —Å–∏–ª—å–Ω–æ –ø–æ–≤—ë—Ä–Ω—É—Ç—ã–µ –∏–ª–∏ –∑–∞—Ç–µ–º–Ω—ë–Ω–Ω—ã–µ –ª–∏—Ü–∞.
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏—è.

#### –ö–ª–∞—Å—Å:
```python
class FaceDetector:
    def __init__(self, confidence_threshold=0.5)
    def detect(self, image: np.ndarray) -> list[tuple]
```

---

### ‚úÖ `src/face_utils/insightface_detector.py`  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ú–æ—â–Ω—ã–π –¥–µ—Ç–µ–∫—Ç–æ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ **RetinaFace** (–≤ —Å–æ—Å—Ç–∞–≤–µ `buffalo_l` –æ—Ç InsightFace).

#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç –º–æ–¥–µ–ª—å `buffalo_l` (~280 –ú–ë) –≤ `~/.insightface/models/`.
2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç ONNX + CPUExecutionProvider.
3. –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ª–∏—Ü–∞ –ø–æ–¥ —É–≥–ª–æ–º, –≤ —Ç–µ–Ω–∏, –≤ –ø—Ä–æ—Ñ–∏–ª—å.
4. –¢–∞–∫–∂–µ –º–æ–∂–µ—Ç –∏–∑–≤–ª–µ–∫–∞—Ç—å:
   - 3D-–ª–∞–Ω–¥–º–∞—Ä–∫–∏,
   - –ø–æ–ª –∏ –≤–æ–∑—Ä–∞—Å—Ç,
   - —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è.

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å,
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤,
- –ì–æ—Ç–æ–≤ –∫ production.

#### –ö–ª–∞—Å—Å:
```python
class InsightFaceDetector:
    def __init__(self, confidence_threshold=0.5)
    def detect(self, image: np.ndarray) -> list[tuple]
```

> üí° –ú–æ–¥–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö –¥–æ 640√ó640 (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ `det_size`).

---

### ‚úÖ `src/face_utils/utils.py`  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.

#### –§—É–Ω–∫—Ü–∏–∏:
```python
def draw_boxes(image, boxes, color=(0, 255, 0), thickness=2) -> np.ndarray
```
- –†–∏—Å—É–µ—Ç –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ –≤–æ–∫—Ä—É–≥ –ª–∏—Ü.
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç RGB ‚Üí –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ BGR > —Ä–∏—Å—É–µ—Ç > –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç RGB.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OpenCV –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏.

> ‚ö†Ô∏è –í –Ω–æ—É—Ç–±—É–∫–∞—Ö –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `matplotlib` (—Å–º. –Ω–∏–∂–µ).

---

## üìì –ù–æ—É—Ç–±—É–∫: `notebooks/01_face_detection.ipynb`

### –≠—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

#### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π
```python
import sys
from pathlib import Path
sys.path.insert(0, str(Path("..").resolve()))
```
‚Üí –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `src.face_utils` –∏–∑ `notebooks/`.

#### 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
```python
image = plt.imread("../data/raw/test.jpg")
# –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ RGB, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
```

#### 3. –î–µ—Ç–µ–∫—Ü–∏—è —á–µ—Ä–µ–∑ OpenCV DNN
- –ë—ã—Å—Ç—Ä–æ, –Ω–æ –º–µ–Ω–µ–µ —Ç–æ—á–Ω–æ.
- –•–æ—Ä–æ—à–æ –¥–ª—è –∞–Ω—Ñ–∞—Å-–ª–∏—Ü.

#### 4. –î–µ—Ç–µ–∫—Ü–∏—è —á–µ—Ä–µ–∑ InsightFace
- –ú–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ **–Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –ª–∏—Ü–∞**.
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ.

#### 5. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `matplotlib`
```python
fig, ax = plt.subplots()
ax.imshow(image)
for (x, y, w, h) in boxes:
    rect = plt.Rectangle((x, y), w, h, edgecolor='green', linewidth=2, facecolor='none')
    ax.add_patch(rect)
```
> –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç OpenCV GUI > –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è Jupyter.

---

## üîç –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

1. –ü–æ–ª–æ–∂–∏—Ç—å —Ñ–æ—Ç–æ –≤ `data/raw/test.jpg`.
2. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
   ```bash
   .venv\Scripts\activate
   ```
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å Jupyter:
   ```bash
   jupyter lab
   ```
4. –û—Ç–∫—Ä—ã—Ç—å `notebooks/01_face_detection.ipynb`.
5. –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ —è—á–µ–π–∫–∏ (**Kernel ‚Üí Restart & Run All**).

---

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç

- –í—ã–≤–æ–¥–∏—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ª–∏—Ü.
- –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Ä–∞–º–∫–∞–º–∏.
- –ú–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –¥–≤—É—Ö –º–æ–¥–µ–ª–µ–π.

---

## üß© –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

| –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å |
|------------|------------------|
| **–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏** | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `app.models["recognition"]` –∏–∑ InsightFace ‚Üí —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ |
| **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** | –°–æ—Ö—Ä–∞–Ω—è—Ç—å `boxes` –≤ JSON –∏–ª–∏ –≤ –ë–î —á–µ—Ä–µ–∑ SQLAlchemy |
| **FastAPI-—Å–µ—Ä–≤–∏—Å** | –°–æ–∑–¥–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç `/detect`, –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π —Ñ–æ—Ç–æ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π JSON |
| **–í–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã** | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ipywidgets` + `cv2.VideoCapture` –≤ `03_live_camera_widget.ipynb` |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–ø–∫–∏** | –¶–∏–∫–ª –ø–æ `data/raw/*.jpg` > —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ `data/processed/` |

---

## üìù –ü—Ä–∏–º–µ—Ä: –∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ

```python
# –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è faces = app.get(img_bgr)
for face in faces:
    embedding = face.embedding  # 512-–º–µ—Ä–Ω—ã–π –≤–µ–∫—Ç–æ—Ä
    # –°—Ä–∞–≤–Ω–∏ —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞–º–∏ (—á–µ—Ä–µ–∑ cosine similarity)
```

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

C–æ–∑–¥–∞–Ω–∞ **–≥–∏–±–∫–∞—è, –º–æ–¥—É–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ª–∏—Ü**, –∫–æ—Ç–æ—Ä–∞—è:

- –†–∞–±–æ—Ç–∞–µ—Ç ¬´–∏–∑ –∫–æ—Ä–æ–±–∫–∏¬ª,
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —É—Ä–æ–≤–Ω—è –∫–∞—á–µ—Å—Ç–≤–∞ (–±—ã—Å—Ç—Ä—ã–π / —Ç–æ—á–Ω—ã–π),
- –õ–µ–≥–∫–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –≤ backend

